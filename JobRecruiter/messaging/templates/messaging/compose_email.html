{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-envelope"></i> Compose Email</h3>
                </div>
                <div class="card-body">
                    <form method="post" id="emailForm">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ form.recipient_username.id_for_label }}" class="form-label">To *</label>
                            {{ form.recipient_username }}
                            <div class="form-text">Start typing a username to search for users</div>
                            <div id="user-suggestions" class="list-group mt-2" style="display: none;"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.subject.id_for_label }}" class="form-label">Subject *</label>
                            {{ form.subject }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.body.id_for_label }}" class="form-label">Message *</label>
                            {{ form.body }}
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button type="submit" name="send" class="btn btn-primary btn-lg px-5">
                                    <i class="fas fa-paper-plane"></i> Send Email
                                </button>
                                <button type="submit" name="draft" class="btn btn-secondary btn-lg px-5 ms-2">
                                    <i class="fas fa-save"></i> Save as Draft
                                </button>
                                <a href="{% url 'messaging:email_inbox' %}" class="btn btn-outline-secondary btn-lg px-5 ms-2">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const recipientInput = document.getElementById('recipient-search');
    const suggestionsDiv = document.getElementById('user-suggestions');
    
    recipientInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (query.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        fetch(`{% url 'messaging:user_search_api' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestionsDiv.innerHTML = '';
                
                if (data.users.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                data.users.forEach(user => {
                    const suggestionItem = document.createElement('a');
                    suggestionItem.href = '#';
                    suggestionItem.className = 'list-group-item list-group-item-action';
                    suggestionItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${user.display_name}</h6>
                            <small>@${user.username}</small>
                        </div>
                        <p class="mb-1">
                            ${user.email || '<span class="text-danger">No email address - user cannot receive emails</span>'}
                        </p>
                    `;
                    
                    suggestionItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        recipientInput.value = user.username;
                        suggestionsDiv.style.display = 'none';
                    });
                    
                    suggestionsDiv.appendChild(suggestionItem);
                });
                
                suggestionsDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching user suggestions:', error);
            });
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!recipientInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
